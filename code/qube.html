<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Qube</title>
</head>
<style>
    *{
        margin: 0;
        padding: 0;
    }
    .container{
        top: 100px; left: 100px; width: 200px; height: 360px; background: black; position: absolute;
    }
    .activityModel, .stationaryModel {
        margin: 1px; width: 19px; height: 19px; background: red; position: absolute; left: 100px;
    }
    .stationaryModel{
        background: #fff;
    }
</style>
<body>
    <div class="container" id="container">
    </div>

    <script type="text/javascript">
        let Qube={};

        (function() {
            var qubeConstructor = function () {
                this._init();
            }
            Object.assign(qubeConstructor.prototype, {
                state : {
                    shapes : [
                        [2,0,2,1,2,2,1,2],
                        [1,0,1,1,1,2,2,2],
                        [0,1,1,1,1,2,2,2],
                        [0,2,1,1,1,2,2,1],
                        [0,0,0,1,1,0,1,1],
                        [0,2,1,1,1,2,2,2]
                    ],
                    shape : [],
                    x : 0,
                    y : 0,
                    size : 20
                },
                setState(newState) {
                    Object.assign(this.state, newState);
                },
                _randomShape() {
                    return this.state.shapes[~~(Math.random() * this.state.shapes.length)]
                },
                _init() {
                    let self = this;

                    this._create()._show();

                    document.onkeydown = (e) => {
                        switch(e.keyCode){
                            case 37 :
                                self._setPosition(-1,0);
                                break;
                            case 38:
                                self._setPosition(0,-1);
                                break;
                            case 39:
                                self._setPosition(1,0);
                                break;
                            case 40:
                                self._setPosition(0,1);
                                break;
                            case 32:
                                self._circlePosition();
                                break;
                            default:
                                break;
                        }
                    }

                    let time = setInterval(function(){
                        self._setPosition(0,1)
                    },1000);

                    return self;
                },
                _create() {
                    let newShape = this._randomShape();
                    this.setState({
                        shape : newShape
                    });
                    for (let i = 0; i < 4; i++) {
                        let div = document.createElement("div");
                        div.className = "activityModel";
                        document.getElementById('container').appendChild(div);
                    }
                    return this;
                },
                _settle() {
                    let divs = document.getElementsByClassName("activityModel");
                    [...divs].forEach((e, i) => {
                        e.className = "stationaryModel";
                    })
                    this.setState({
                        x: 0,
                        y: 0
                    })
                    return this;
                },
                _show() {
                    let self =this;
                    let divs = document.getElementsByClassName("activityModel");
                    [...divs].forEach((e, i) => {
                        e.style.top = (self.state.shape[i * 2 + 1] + self.state.y) * self.state.size + "px";
                        e.style.left = (self.state.shape[i * 2] + self.state.x) * self.state.size + 60 +  "px";
                    })
                },
                _setPosition(x,y) {
                    if(this._check(this.state.x + x, this.state.y + y, this.state.shape)){
                        this.setState({
                            x: this.state.x + x,
                            y: this.state.y + y
                        })
                        this._show();
                    }else{
                        if(y === 0){ return }
                        this._settle()._create()._show();
                    }
                },
                _circlePosition() {
                    let shape = this.state.shape;
                    shape = [shape[1], 2 - shape[0], shape[3], 2 - shape[2], shape[5], 2 - shape[4], shape[7], 2 - shape[6]];
                    if(!this._check(this.state.x, this.state.y, shape)) return ;
                    this.setState({
                        shape
                    });
                    this._show();
                },
                _check(x, y, shape) {
                    let minX = Math.min.apply(null, shape.filter((e, i) => i%2 === 0));
                    let minY = Math.min.apply(null, shape.filter((e, i) => i%2 === 1));
                    let maxX = Math.max.apply(null, shape.filter((e, i) => i%2 === 0));
                    let maxY = Math.max.apply(null, shape.filter((e, i) => i%2 === 1));
                    if ((maxX + x + 1) > 7 || (minX + x) < -3 ||
                        (maxY + y + 1) > 18 || (minY + y) < 0){
                        return false;
                    }else{
                        return true;
                    }

                }
            })

            Qube.qubeConstructor = qubeConstructor;
        })();

        new Qube.qubeConstructor();
    </script>
</body>
</html>